<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FriendSync</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Patrick+Hand&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --paper: #fdf6e3; --ink: #2c3e50; --accent: #e67e22; --green: #27ae60; --red: #c0392b; --border: 3px solid #2c3e50;
        }

        body {
            font-family: 'Patrick Hand', cursive; background-color: #dcdde1;
            background-image: url('https://www.transparenttextures.com/patterns/felt.png');
            color: var(--ink); margin: 0; display: flex; flex-direction: column;
            align-items: center; min-height: 100vh; overflow-x: hidden; padding-bottom: 100px;
        }

        .screen { display: none; width: 92%; max-width: 500px; text-align: center; margin-top: 20px; animation: bounceIn 0.5s ease; flex-direction: column; align-items: center; }
        .screen.active { display: flex; }
        @keyframes bounceIn { 0% { transform: scale(0.8); opacity: 0; } 70% { transform: scale(1.05); } 100% { transform: scale(1); opacity: 1; }}

        .paper-card { background: var(--paper); border: var(--border); border-radius: 15px 5px 15px 5px; padding: 25px; box-shadow: 8px 8px 0 rgba(0,0,0,0.1); width: 100%; box-sizing: border-box; margin-bottom: 20px; }
        h1 { font-family: 'Fredoka One', cursive; color: var(--accent); font-size: 3.2em; margin: 0; text-shadow: 3.3px 3.3px 0 var(--ink); }
        h2 { font-family: 'Fredoka One', cursive; font-size: 1.6em; }

        .btn { background: var(--accent); color: white; border: var(--border); padding: 16px 25px; font-size: 1.4em; font-family: 'Fredoka One', cursive; border-radius: 10px 5px 10px 5px; cursor: pointer; margin: 10px 0; width: 90%; box-shadow: 4px 4px 0 var(--ink); transition: 0.1s; }
        .btn:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0 var(--ink); }

        input[type="text"], input[type="number"], input[type="range"] { padding: 12px; border: 2.5px solid var(--ink); border-radius: 10px; background: rgba(255,255,255,0.8); font-size: 1.1em; width: 85%; margin-bottom: 10px; text-align: center; }

        #timer-container { width: 100%; height: 14px; background: #eee; border-bottom: 3px solid var(--ink); position: fixed; top: 0; z-index: 2000; display: none; }
        #timer-bar { height: 100%; background: var(--accent); width: 100%; transform-origin: left; }

        #sortable-list { list-style: none; padding: 0; width: 100%; }
        #sortable-list li { background: white; border: 2.5px solid var(--ink); margin: 12px 0; padding: 15px; border-radius: 10px; font-weight: bold; font-size: 1.3em; display: flex; flex-direction: column; align-items: center; box-shadow: 5px 5px 0 rgba(0,0,0,0.1); touch-action: none; cursor: grab; user-select: none; }
        .option-img { width: 100%; max-height: 150px; object-fit: cover; border-radius: 8px; margin-top: 10px; }

        /* INSPECTOR CARDS */
        .tab-btn { background: white; border: 2px solid var(--ink); padding: 8px 18px; border-radius: 20px; white-space: nowrap; cursor: pointer; font-family: 'Fredoka One', cursive; margin-right: 8px; }
        .tab-btn.active { background: var(--accent); color: white; transform: translateY(-3px); }
        .res-card { background: white; border: 2px solid var(--ink); padding: 15px; margin: 8px 0; border-radius: 10px; display: flex; justify-content: space-between; font-size: 1.2em; font-weight: bold;}
        .res-correct { border-left: 12px solid var(--green); }
        .res-wrong { border-left: 12px solid var(--red); opacity: 0.7; }

        /* CUSTOM CREATOR STYLES */
        .custom-row {
            display: flex;
            align-items: center;
            background: white;
            border: 2px solid var(--ink);
            border-radius: 10px;
            padding: 8px;
            margin-bottom: 10px;
            gap: 10px;
            position: relative;
        }
        .img-upload-box {
            width: 70px;
            height: 70px;
            background: #eee;
            border: 2px dashed #aaa;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            overflow: hidden;
            position: relative;
            flex-shrink: 0;
        }
        .img-upload-box:hover { background: #e1e1e1; }
        .img-upload-box img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .img-upload-box span { font-size: 2em; color: #aaa; line-height: 0; padding-bottom: 5px; }
        .c-opt-text { width: 100% !important; margin: 0 !important; border: none !important; background: transparent !important; text-align: left !important; font-weight: bold; }
        
        /* IMPROVED QUESTION BOX */
        #c-prompt {
            width: 100% !important;
            box-sizing: border-box;
            background: white;
            border: 3px solid var(--accent) !important;
            color: var(--accent);
            font-family: 'Fredoka One';
            font-size: 1.5em !important;
            padding: 15px !important;
            margin-bottom: 20px !important;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.05);
        }
        #c-prompt::placeholder { color: #f39c12; opacity: 0.6; }

        /* DELETE BUTTON */
        .del-btn {
            background: var(--red);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Fredoka One';
            cursor: pointer;
            margin-left: 5px;
            flex-shrink: 0;
            box-shadow: 2px 2px 0 var(--ink);
        }
        .del-btn:active { transform: translate(1px, 1px); box-shadow: none; }

        /* FINALE LAYERS */
        .finale-card { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--paper); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 5000; animation: bounceIn 0.5s; background-image: url('https://www.transparenttextures.com/patterns/felt.png'); }
        .finale-text { font-family: 'Fredoka One'; font-size: 4em; color: var(--accent); text-shadow: 4px 4px 0 var(--ink); }
        
        /* FINAL SUMMARY BOX */
        .final-stat-box {
            background: white;
            border: 2px solid var(--ink);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            width: 100%;
            box-sizing: border-box;
            text-align: left;
        }
        .stat-label { font-size: 0.9em; color: #7f8c8d; font-weight: bold; text-transform: uppercase; }
        .stat-val { font-size: 1.5em; font-family: 'Fredoka One'; color: var(--ink); }

        /* SPINNER */
        .spinner { width: 50px; height: 50px; border: 5px solid #ccc; border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { to { transform: rotate(360deg); }}
    </style>
</head>
<body>

    <div id="timer-container"><div id="timer-bar"></div></div>
    <div id="room-display" style="position:fixed; top:20px; right:20px; background:var(--ink); color:white; padding:5px 15px; border-radius:20px; font-weight:bold; display:none; z-index:2100; font-family: 'Fredoka One';">----</div>

    <div id="screen-home" class="screen active">
        <h1>FriendSync</h1>
        <div class="paper-card">
            <p style="font-size: 1.6em; margin: 0;">How well do you know your friends?</p><br>
            <input type="text" id="username" placeholder="Your Name">
            <button class="btn" onclick="createRoom()">CREATE PARTY</button>
            <div style="margin: 10px; font-weight:bold;">- OR -</div>
            <input type="text" id="room-code-input" placeholder="ROOM CODE">
            <button class="btn" style="background:var(--red);" onclick="joinRoom()">JOIN PARTY</button>
        </div>
    </div>

    <div id="screen-lobby" class="screen">
        <div class="paper-card">
            <h2>Lobby</h2>
            <h1 id="lobby-code" style="text-shadow: none; font-size: 4.5em;">----</h1>
            <div id="lobby-list" style="display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin:20px 0;"></div>
            <div id="host-controls" style="display:none; width:100%;">
                <div style="background: rgba(0,0,0,0.05); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                    <label style="font-weight:bold;">Rounds: <span id="disp-rounds">5</span></label>
                    <input type="range" id="inp-rounds" min="3" max="15" value="5" oninput="updateSetDisplay()" style="width:100%;">
                    <br><br>
                    <label style="font-weight:bold;">Timer: <span id="disp-timer">60</span>s</label>
                    <input type="range" id="inp-timer" min="20" max="120" value="60" oninput="updateSetDisplay()" style="width:100%;">
                </div>
                <button class="btn" onclick="startGame()">START SYNC</button>
            </div>
        </div>
    </div>

    <div id="screen-selection" class="screen">
        <div class="paper-card">
            <h3>Round <span id="round-num"></span></h3>
            <h2 id="sel-title">YOU ARE SPOTLIGHT!</h2>
            <p>Select a topic to see how well they know you...</p>
            
            <div id="topic-container" style="display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin-bottom: 15px;"></div>
            
            <button class="btn" onclick="toggleCustomCreator()" style="font-size: 1.1em; background: #34495e;">+ CREATE FROM SCRATCH</button>
            
            <div id="custom-creator" style="display:none; margin-top: 20px; border-top: 2px dashed var(--ink); padding-top: 20px;">
                <input id="c-prompt" placeholder="Type Your Question Here...">
                
                <div id="custom-opts-container"></div>
                <button class="btn" onclick="addOptionRow()" style="background:#eee; color:black; font-size: 1em; width: 60%; border:2px solid var(--ink);">+ Add Option</button>
                <button class="btn" onclick="submitCustom()">LAUNCH LIST</button>
            </div>
        </div>
    </div>

    <div id="screen-waiting" class="screen">
        <div class="paper-card loading-facts">
            <h2 id="wait-name"></h2>
            <div class="spinner"></div>
            <p id="fact-display" style="font-size: 1.4em; min-height: 80px; transition: opacity 0.5s;"></p>
            <p style="opacity: 0.6;">Hang tight while they sync up...</p>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="paper-card">
            <div id="role-indicator" style="background:var(--ink); color:white; padding:10px; border-radius:8px; margin-bottom:15px; font-weight:bold;"></div>
            <h2 id="q-prompt" style="margin-bottom: 10px;"></h2>
            <ul id="sortable-list"></ul>
            <button class="btn" id="btn-submit" onclick="submitRank()">LOCK IN RANKING</button>
        </div>
    </div>

    <div id="screen-results" class="screen">
        <div class="paper-card">
            <h2 style="margin:0">Performance Check</h2>
            <div style="text-align: left; background: #efefef; padding: 15px; border: 2px solid var(--ink); border-radius: 12px; margin: 15px 0;">
                <p style="margin:0; font-weight:bold; color:var(--accent); font-size: 1.2em;">The Truth (<span id="res-spot-name"></span>):</p>
                <div id="correct-list-summary"></div>
            </div>
            <div id="player-tabs" style="display:flex; overflow-x:auto; padding-bottom:10px; width: 100%;"></div>
            <div id="detail-view" style="width: 100%;"></div>
            <button class="btn" id="btn-next" onclick="nextRound()" style="display:none; margin-top:20px;">NEXT ROUND</button>
        </div>
    </div>

    <div id="finale-winner" class="finale-card"><div class="finale-text">WINNER:</div><h1 id="f-winner-name" style="font-size:5em;"></h1></div>
    <div id="finale-soulmates" class="finale-card"><h1>SOULMATES ðŸ’–</h1><h2 id="f-soul-name"></h2></div>
    <div id="finale-strangers" class="finale-card"><h1>STRANGERS ðŸ‘»</h1><h2 id="f-stranger-name"></h2></div>

    <div id="screen-over" class="screen">
        <div class="paper-card">
            <h1>Game Summary</h1>
            
            <div style="display:flex; gap:10px; margin-bottom: 15px;">
                <div class="final-stat-box" style="border-color: var(--accent);">
                    <div class="stat-label">Winner ðŸ‘‘</div>
                    <div class="stat-val" id="sum-winner"></div>
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <div class="final-stat-box" style="border-color: #e91e63;">
                    <div class="stat-label">Soulmates ðŸ’–</div>
                    <div class="stat-val" id="sum-soul" style="font-size:1.1em;"></div>
                </div>
                <div class="final-stat-box" style="border-color: #607d8b;">
                    <div class="stat-label">Strangers ðŸ‘»</div>
                    <div class="stat-val" id="sum-stranger" style="font-size:1.1em;"></div>
                </div>
            </div>

            <h2>Leaderboard</h2>
            <div id="final-leaderboard" style="width:100%; margin-bottom: 20px;"></div>
            
            <div id="host-final-controls" style="display:none; width:100%;">
                <button class="btn" onclick="playAgain()">PLAY AGAIN</button>
                <button class="btn" style="background:var(--red);" onclick="endRoom()">END PARTY</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <script>
        const socket = io();
        let myId, currentCorrectOrder, currentRoundResults, isHost, hasSubmitted = false, localTimer = null, sortableInstance = null;
        let factInterval;
        let finalDataCache = null;

        const LOCAL_TOPICS = [
            { p: "Best Pizza Topping", o: ["Pepperoni", "Pineapple", "Mushrooms", "Extra Cheese", "Olives"] },
            { p: "Worst Chore", o: ["Dishes", "Laundry", "Vacuuming", "Taking out Trash", "Cleaning Bathroom"] },
            { p: "Best Superpower", o: ["Flight", "Invisibility", "Teleportation", "Super Strength", "Time Travel"] },
            { p: "Best Fast Food", o: ["McDonalds", "KFC", "Burger King", "Subway", "Taco Bell"] },
            { p: "Scariest Animal", o: ["Snake", "Spider", "Shark", "Bear", "Cockroach"] },
            { p: "Best Season", o: ["Summer", "Winter", "Autumn", "Spring"] },
            { p: "Best Movie Genre", o: ["Horror", "Comedy", "Action", "Romance", "Sci-Fi"] },
            { p: "Most Annoying Sound", o: ["Crying Baby", "Chalk on Board", "Chewing Loudly", "Alarm Clock", "Mosquito"] },
            { p: "Best Ice Cream Flavor", o: ["Chocolate", "Vanilla", "Strawberry", "Mint Chip", "Cookie Dough"] },
            { p: "Best Social Media", o: ["Instagram", "TikTok", "Twitter/X", "YouTube", "Snapchat"] },
            { p: "Worst Way to Die", o: ["Burning", "Drowning", "Falling", "Buried Alive", "Frozen"] },
            { p: "Best Breakfast", o: ["Pancakes", "Waffles", "Eggs & Bacon", "Cereal", "Toast"] },
            { p: "Zombie Apocalypse Weapon", o: ["Shotgun", "Katana", "Bat", "Flamethrower", "Chainsaw"] },
            { p: "Best Holiday", o: ["Christmas", "Halloween", "Thanksgiving", "Easter", "New Years"] },
            { p: "Best Color", o: ["Blue", "Red", "Green", "Purple", "Black"] },
            { p: "Cutest Pet", o: ["Dog", "Cat", "Hamster", "Bunny", "Parrot"] },
            { p: "Worst Fruit", o: ["Durian", "Grapefruit", "Papaya", "Tomato", "Lemon"] },
            { p: "Best Drink", o: ["Water", "Soda", "Coffee", "Tea", "Juice"] },
            { p: "Best Streaming Service", o: ["Netflix", "Hulu", "Disney+", "HBO", "Prime"] },
            { p: "Most Important Trait", o: ["Humor", "Loyalty", "Intelligence", "Kindness", "Wealth"] },
            { p: "Best School Subject", o: ["Math", "Science", "History", "Art", "Gym"] },
            { p: "Best Video Game Genre", o: ["FPS", "RPG", "Sports", "Puzzle", "Battle Royale"] },
            { p: "Worst Smell", o: ["Skunk", "Rotten Egg", "Garbage", "Wet Dog", "Burnt Hair"] },
            { p: "Best Place to Date", o: ["Cinema", "Park", "Restaurant", "Beach", "Home"] },
            { p: "Best Music Genre", o: ["Pop", "Rock", "Rap", "Country", "EDM"] },
            { p: "Scariest Horror Movie Villain", o: ["Freddy", "Jason", "Pennywise", "Chucky", "Ghostface"] },
            { p: "Best Chocolate Bar", o: ["Snickers", "KitKat", "Twix", "Mars", "Hersheys"] },
            { p: "Best Board Game", o: ["Monopoly", "Uno", "Scrabble", "Clue", "Risk"] },
            { p: "Most Useful Invention", o: ["Internet", "Electricity", "Wheel", "Phone", "Plane"] },
            { p: "Best Fry Shape", o: ["Curly", "Waffle", "Shoestring", "Steak", "Crinkle"] }
        ];

        const funFacts = [
            "Strawberries aren't actually berries, but bananas are!",
            "Octopuses have three hearts.",
            "Wombat poop is cube-shaped.",
            "Honey never spoils.",
            "A group of flamingos is called a 'flamboyance'.",
            "Sharks have been around longer than trees.",
            "The heart of a shrimp is located in its head."
        ];

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('timer-container').style.display = (id === 'screen-game') ? 'block' : 'none';
            if (id !== 'screen-waiting') clearInterval(factInterval);
        }

        function rotateFacts() {
            const display = document.getElementById('fact-display');
            let i = 0;
            display.innerText = funFacts[0];
            factInterval = setInterval(() => {
                display.style.opacity = 0;
                setTimeout(() => {
                    i = (i + 1) % funFacts.length;
                    display.innerText = funFacts[i];
                    display.style.opacity = 1;
                }, 500);
            }, 4000);
        }

        // --- NEW CUSTOM CREATOR LOGIC ---
        function toggleCustomCreator() {
            const el = document.getElementById('custom-creator');
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
            if(el.style.display === 'block') {
                document.getElementById('custom-opts-container').innerHTML = "";
                for(let i=0; i<4; i++) addOptionRow();
            }
        }

        function addOptionRow() {
            const container = document.getElementById('custom-opts-container');
            if(container.children.length >= 10) return;
            const div = document.createElement('div');
            div.className = 'custom-row';
            // Added delete button
            div.innerHTML = `
                <div class="img-upload-box" onclick="this.querySelector('input').click()" ondrop="dropHandler(event)" ondragover="dragOverHandler(event)">
                    <span>+</span>
                    <img class="preview">
                    <input type="file" accept="image/*" hidden onchange="fileInputHandler(this)">
                </div>
                <input class="c-opt-text" placeholder="Option Text Here...">
                <button class="del-btn" onclick="deleteRow(this)">X</button>
            `;
            container.appendChild(div);
        }

        // NEW: DELETE FUNCTION
        function deleteRow(btn) {
            const container = document.getElementById('custom-opts-container');
            if(container.children.length <= 4) {
                return alert("You must have at least 4 options!");
            }
            btn.closest('.custom-row').remove();
        }

        // Drag & Drop Handlers
        function dragOverHandler(ev) { ev.preventDefault(); }
        function dropHandler(ev) {
            ev.preventDefault();
            if (ev.dataTransfer.items && ev.dataTransfer.items[0].kind === 'file') {
                const file = ev.dataTransfer.items[0].getAsFile();
                processFile(file, ev.target.closest('.img-upload-box'));
            }
        }
        function fileInputHandler(input) {
            if (input.files && input.files[0]) {
                processFile(input.files[0], input.closest('.img-upload-box'));
            }
        }
        function processFile(file, box) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = box.querySelector('.preview');
                const span = box.querySelector('span');
                img.src = e.target.result;
                img.style.display = 'block';
                span.style.display = 'none';
            }
            reader.readAsDataURL(file);
        }

        function submitCustom() {
            const p = document.getElementById('c-prompt').value;
            // Scrape data from new structure
            const rows = Array.from(document.querySelectorAll('.custom-row'));
            const opts = rows.map(row => {
                const text = row.querySelector('.c-opt-text').value;
                const img = row.querySelector('.preview').style.display === 'block' ? row.querySelector('.preview').src : null;
                return { text, image: img };
            }).filter(o => o.text);

            if(opts.length < 2) return alert("Min 2 options!");
            socket.emit('submitTopic', { type: 'CUSTOM', prompt: p, options: opts });
        }

        function submitLocalTopic(index) {
            // Converts a local preset into a "Custom" submission so the server accepts it
            const t = LOCAL_TOPICS[index];
            const opts = t.o.map(txt => ({ text: txt, image: null }));
            socket.emit('submitTopic', { type: 'CUSTOM', prompt: t.p, options: opts });
        }

        socket.on('updateState', (state) => {
            myId = socket.id; isHost = (socket.id === state.hostId);
            document.getElementById('lobby-code').innerText = state.roomCode;
            document.getElementById('room-display').innerText = state.roomCode;
            document.getElementById('room-display').style.display = 'block';
            document.getElementById('lobby-list').innerHTML = state.players.map(p => `<div style="background:white; border:2.5px solid var(--ink); padding:10px; border-radius:10px; font-weight:bold;">${p.name} ${p.isHost?'ðŸ‘‘':''}</div>`).join('');
            if(state.phase === 'LOBBY') showScreen('screen-lobby');
            document.getElementById('host-controls').style.display = isHost ? 'block' : 'none';
        });

        socket.on('goToSelection', (data) => {
            if(socket.id === data.spotlightId) {
                showScreen('screen-selection');
                document.getElementById('round-num').innerText = data.roundInfo;
                
                // --- INJECT RANDOM LOCAL TOPICS ---
                const container = document.getElementById('topic-container');
                container.innerHTML = "";
                
                // Shuffle local topics and pick 6
                const shuffled = [...LOCAL_TOPICS].sort(() => 0.5 - Math.random());
                const selected = shuffled.slice(0, 6);

                selected.forEach((t) => {
                    const originalIndex = LOCAL_TOPICS.indexOf(t);
                    const div = document.createElement('div');
                    div.style.cssText = "background:white; border:2.5px solid var(--ink); padding:12px; border-radius:10px; cursor:pointer; font-weight:bold; width:45%; box-sizing:border-box;";
                    div.innerText = t.p;
                    div.onclick = () => submitLocalTopic(originalIndex);
                    container.appendChild(div);
                });
                
            } else {
                showScreen('screen-waiting');
                document.getElementById('wait-name').innerText = `How well do you know ${data.spotlightName}?`;
                rotateFacts();
            }
        });

        socket.on('roundStart', (data) => {
            showScreen('screen-game'); hasSubmitted = false;
            document.getElementById('q-prompt').innerText = data.question.prompt;
            const isSpot = (socket.id === data.spotlightId);
            document.getElementById('role-indicator').innerText = isSpot ? "ðŸ”¦ RANK THE TRUTH" : `HOW WELL DO YOU KNOW ${data.spotlightName.toUpperCase()}?`;
            
            const bar = document.getElementById('timer-bar');
            bar.style.transition = 'none'; bar.style.width = '100%';
            void bar.offsetWidth; bar.style.transition = `width ${data.duration}s linear`; bar.style.width = '0%';

            if(localTimer) clearTimeout(localTimer);
            localTimer = setTimeout(() => { if(!hasSubmitted) submitRank(); }, data.duration * 1000);

            const list = document.getElementById('sortable-list'); list.innerHTML = "";
            let options = data.question.options.map(o => typeof o === 'string' ? {text: o} : o);
            [...options].sort(()=>Math.random()-0.5).forEach(item => {
                const li = document.createElement('li');
                let html = `<span class="item-text">${item.text}</span>`;
                if(item.image) html += `<img src="${item.image}" class="option-img">`;
                li.innerHTML = html;
                list.appendChild(li);
            });
            if (sortableInstance) sortableInstance.destroy();
            sortableInstance = new Sortable(list, { animation: 150, forceFallback: true });
            document.getElementById('btn-submit').style.display = 'block';
        });

        function submitRank() {
            if(hasSubmitted) return; hasSubmitted = true;
            const rank = Array.from(document.querySelectorAll('#sortable-list li')).map(li => ({
                text: li.querySelector('.item-text').innerText,
                image: li.querySelector('.option-img') ? li.querySelector('.option-img').src : null
            }));
            socket.emit('submitRank', rank);
            document.getElementById('btn-submit').style.display = 'none';
        }

        socket.on('roundOver', (data) => {
            showScreen('screen-results'); if(localTimer) clearTimeout(localTimer);
            currentCorrectOrder = data.correctOrder;
            currentRoundResults = data.results.sort((a,b) => b.points - a.points);
            document.getElementById('res-spot-name').innerText = data.spotlightName;
            document.getElementById('correct-list-summary').innerHTML = data.correctOrder.map((it,i) => `<div>${i+1}. ${it.text}</div>`).join('');
            
            const tabContainer = document.getElementById('player-tabs'); tabContainer.innerHTML = "";
            currentRoundResults.forEach((res, index) => {
                const btn = document.createElement('div'); btn.className = 'tab-btn';
                btn.innerHTML = `${res.name} <span style="color:var(--accent)">+${res.points}</span>`;
                btn.onclick = () => renderPlayerDetail(index); btn.id = `tab-${index}`;
                tabContainer.appendChild(btn);
            });
            renderPlayerDetail(0);
            document.getElementById('btn-next').style.display = isHost ? 'block' : 'none';
        });

        function renderPlayerDetail(index) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            if(document.getElementById(`tab-${index}`)) document.getElementById(`tab-${index}`).classList.add('active');
            const data = currentRoundResults[index];
            const container = document.getElementById('detail-view'); container.innerHTML = "";
            if (!data || !data.rank) return;
            container.innerHTML = `<h3>${data.name.toUpperCase()}'S RANKING:</h3>`;
            data.rank.forEach((item, idx) => {
                const isC = (item.text === currentCorrectOrder[idx].text);
                container.innerHTML += `<div class="res-card ${isC?'res-correct':'res-wrong'}"><span>${idx+1}. ${item.text}</span> ${isC?'<span style="background:var(--green); color:white; padding:2px 8px; border-radius:5px; font-size:0.8em;">+10</span>':''}</div>`;
            });
        }

        socket.on('gameOver', (data) => {
            finalDataCache = data; 
            
            const winner = document.getElementById('finale-winner');
            const soul = document.getElementById('finale-soulmates');
            const stranger = document.getElementById('finale-strangers');

            winner.style.display = 'flex';
            document.getElementById('f-winner-name').innerText = data.winner.name;
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });

            setTimeout(() => {
                winner.style.display = 'none';
                soul.style.display = 'flex';
                document.getElementById('f-soul-name').innerText = data.soulmates.names;
            }, 3000);

            setTimeout(() => {
                soul.style.display = 'none';
                stranger.style.display = 'flex';
                document.getElementById('f-stranger-name').innerText = data.strangers.names;
            }, 6000);

            setTimeout(() => {
                stranger.style.display = 'none';
                showScreen('screen-over');
                
                document.getElementById('sum-winner').innerText = data.winner.name;
                document.getElementById('sum-soul').innerText = data.soulmates.names || "None";
                document.getElementById('sum-stranger').innerText = data.strangers.names || "None";

                document.getElementById('final-leaderboard').innerHTML = data.leaderboard.map((p, i) => `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:2px dashed #ccc; font-weight:bold;"><span>#${i+1} ${p.name}</span> <span>${p.score} PTS</span></div>`).join('');
                if(isHost) document.getElementById('host-final-controls').style.display = 'block';
            }, 9000);
        });

        function createRoom() { const n = document.getElementById('username').value; if(n) socket.emit('createRoom', n); }
        function joinRoom() { const n = document.getElementById('username').value; const c = document.getElementById('room-code-input').value; if(n&&c) socket.emit('joinRoom', {playerName:n, roomCode:c}); }
        function startGame() { socket.emit('startGame', { rounds: document.getElementById('inp-rounds').value, timer: document.getElementById('inp-timer').value }); }
        function nextRound() { socket.emit('nextRound'); }
        function playAgain() { socket.emit('playAgain'); }
        function endRoom() { socket.emit('endRoom'); }
        function updateSetDisplay() { document.getElementById('disp-rounds').innerText = document.getElementById('inp-rounds').value; document.getElementById('disp-timer').innerText = document.getElementById('inp-timer').value; }
        socket.on('roomDestroyed', () => { alert("Host Ended Room"); location.reload(); });
        socket.on('errorMsg', msg => alert(msg));
    </script>
</body>
</html>